# ECサイト要件定義書

## 1. プロジェクト概要

### 1.1 目的
維持費を最小限に抑えた小規模ECサイトの構築

### 1.2 規模感
- 商品数: 50個未満
- 想定取引数: 少なめ（月間数件〜数十件程度）
- 運用体制: 個人（Ryoya）

### 1.3 コスト目標
- 月額固定費: 実質0円
- 従量課金: 決済手数料のみ（Stripe 3.6%）

---

## 2. 技術スタック

### 2.1 フロントエンド
- フレームワーク: Astro 5.x（SSRモード）
- UIコンポーネント: Svelte（Astro Shopifyテーマを参考）
- スタイリング: Tailwind CSS
- ホスティング: Vercel（無料プラン）

### 2.2 バックエンド・API
- 商品マスタ管理: microCMS（無料プラン: 10,000API/月）
- 決済処理: Stripe（決済手数料のみ、月額費用なし）
- サーバーサイド処理: Astro API Routes + Vercel Functions

### 2.3 データ管理
- 注文データ保存: Google Spreadsheet
- 在庫管理: microCMSの商品データ内フィールド
- バッチ処理: Vercel Cron Jobs

### 2.4 通知・連携
- 注文通知・エラー通知: Slack
- メール送信: Stripe経由（決済完了メール等）

---

## 3. 機能要件

### 3.1 商品表示機能

#### 3.1.1 商品一覧ページ
- microCMSから商品データ取得（SSR）
- 商品画像、商品名、価格、在庫状況を表示
- フィルタリング・ソート機能（optional）
- ページネーション（商品数が少ないため不要かもしれない）

#### 3.1.2 商品詳細ページ
- 商品画像ギャラリー（複数画像対応）
- 商品名、価格、説明文、スペック情報
- リアルタイム在庫数表示
- カートへ追加ボタン
- 関連商品表示（optional）

#### 3.1.3 商品データ構造（microCMS）
```
商品（Product）:
  - id: string (自動生成)
  - name: string (商品名)
  - slug: string (URL用スラッグ)
  - description: richtext (商品説明)
  - price: number (価格・税込)
  - images: 複数画像 (メイン画像 + サブ画像)
  - stock: number (在庫数)
  - sku: string (SKUコード)
  - category: reference (カテゴリ・optional)
  - specifications: JSON (スペック情報・optional)
  - isActive: boolean (公開/非公開)
  - createdAt: datetime
  - updatedAt: datetime
```

### 3.2 カート機能

#### 3.2.1 カート管理
- クライアントサイドで状態管理（Svelte store、参考: Astro Shopifyのcart.ts）
- LocalStorageに保存（ページリロード時に復元）
- カート内容:
  - 商品ID、商品名、価格、数量、小計
  - 合計金額、合計アイテム数

#### 3.2.2 カートUI（Astro Shopify参考）
- カートドロワー（サイドバー）
- 数量変更機能
- アイテム削除機能
- チェックアウトボタン

#### 3.2.3 在庫チェック
- カート投入時: クライアント側で在庫確認（microCMS API）
- チェックアウト時: サーバー側で再度在庫確認（Astro API Route）

### 3.3 決済機能

#### 3.3.1 Stripe Checkout統合
- Astro API Route（/api/create-checkout-session）でセッション作成
- Stripe Checkoutページへリダイレクト
- Stripe Checkoutで収集する情報:
  - メールアドレス
  - 配送先住所（shipping_address_collection: Japan）
  - 支払い情報（カード決済）

#### 3.3.2 決済フロー
1. ユーザーがカートから「購入手続き」をクリック
2. Astro API Routeで在庫を再確認
3. 在庫OKなら Stripe Checkout Session作成
4. Stripe Checkoutページへリダイレクト
5. ユーザーが住所・決済情報入力
6. 決済完了後、成功ページへリダイレクト（/success）
7. キャンセル時、カートページへ戻る（/cart）

#### 3.3.3 API Route実装
- エンドポイント: POST /api/create-checkout-session
- リクエストボディ: カート内容（商品ID、数量）
- 処理内容:
  - microCMSから最新在庫取得
  - 在庫不足の場合エラーレスポンス
  - Stripe Checkout Session作成
  - セッションURLを返却

### 3.4 在庫管理機能

#### 3.4.1 在庫減算処理
- トリガー: Stripe webhook（checkout.session.completed）
- 処理内容:
  1. Webhookペイロードを署名検証
  2. 注文情報を抽出（商品、数量、金額、住所）
  3. microCMS APIで在庫数を減算（PATCH リクエスト）
  4. Google Spreadsheetに注文記録を追加
  5. Slackに注文通知を送信
  6. エラー時はSlackにエラー通知

#### 3.4.2 在庫管理の考慮事項
- 同時購入の競合対策: 
  - チェックアウト時に在庫確保（仮押さえ）はせず、先着順で処理
  - webhook失敗時はバッチで検出・補正
- 在庫切れ時の表示:
  - 「在庫切れ」表示、カート追加ボタン無効化

### 3.5 注文データ管理

#### 3.5.1 Google Spreadsheet構造
```
シート名: 注文一覧
列:
  A: 注文ID（Stripe Payment Intent ID）
  B: 注文日時（ISO 8601形式）
  C: 商品名（複数商品の場合は改行区切り）
  D: 数量（複数商品の場合は改行区切り）
  E: 単価（複数商品の場合は改行区切り）
  F: 合計金額
  G: 顧客メールアドレス
  H: 配送先郵便番号
  I: 配送先住所
  J: 配送先氏名
  K: 電話番号（optional、Stripeから取得可能な場合）
  L: ステータス（未発送/発送済み/完了/キャンセル）
  M: 在庫減算済みフラグ（TRUE/FALSE）
  N: 備考
  O: Stripe決済URL（ダッシュボードへのリンク）
```

#### 3.5.2 データ保存API
- Astro API Route（/api/save-order）またはwebhook内で直接保存
- Google Sheets APIを使用
- 認証: サービスアカウント（JSON Key）

### 3.6 データ整合性チェック（バッチ処理）

#### 3.6.1 実行スケジュール
- 1日1回、午前9時に実行（Vercel Cron）
- 設定: vercel.json
```json
{
  "crons": [{
    "path": "/api/check-orders",
    "schedule": "0 0 * * *"
  }]
}
```

#### 3.6.2 処理内容
1. 過去24時間のStripe注文を取得（Stripe API）
2. Google Spreadsheetの注文データを取得
3. 突合チェック:
   - Stripeにあってスプレッドシートにない注文
   - スプレッドシートにあってStripeにない注文（通常あり得ない）
   - 金額・商品の不一致
   - 在庫減算フラグがFALSEのまま残っている注文
4. 差分検出時:
   - Slack通知（注文ID、金額、商品名、エラー内容）
   - 通知メッセージ例: 
     「⚠️ 未記録の注文を検出しました
     注文ID: pi_xxxxxxxx
     金額: ¥3,500
     商品: 商品A x2
     決済日時: 2026-02-14 15:30
     Stripeダッシュボード: [リンク]」
5. 自動修正はせず、人間が確認・手動対応

#### 3.6.3 Slack通知設定
- Incoming Webhook URL使用
- チャンネル: #ec-orders（例）
- 通知内容: 差分情報、エラー内容、対応が必要な旨

---

## 4. 非機能要件

### 4.1 パフォーマンス
- Lighthouse スコア: 90点以上を目標
- SSRによる初期表示の最適化
- 画像の最適化（Astro Image最適化機能）

### 4.2 セキュリティ
- Stripe webhook署名検証の実装
- 環境変数での機密情報管理（.env）
- microCMS API Key管理（サーバーサイドのみ）
- HTTPS通信（Vercel標準対応）

### 4.3 スケーラビリティ
- Vercel無料プランの制限:
  - Function実行時間: 10秒
  - 帯域幅: 100GB/月
  - Function実行回数: 制限なし
- microCMS無料プランの制限:
  - APIコール数: 10,000回/月
  - 商品数が少なく、アクセスも少ないため問題なし

### 4.4 運用保守性
- エラー通知: Slackへ即時通知
- ログ: Vercel Function Logs + Stripe Dashboard
- バックアップ: Google Spreadsheetは自動バックアップ（Google Drive）
- デプロイ: Git pushで自動デプロイ（Vercel連携）

---

## 5. ページ構成

### 5.1 フロントエンド主要ページ
```
/                        トップページ（商品一覧または特集）
/products                商品一覧ページ
/products/[slug]         商品詳細ページ
/cart                    カートページ（optional、ドロワーのみでも可）
/success                 決済成功ページ
/cancel                  決済キャンセルページ
```

### 5.2 API Routes
```
POST /api/create-checkout-session    Stripe Checkoutセッション作成
POST /api/webhook                     Stripe webhook受信
GET  /api/check-orders                バッチ処理（Vercel Cron）
```

---

## 6. 外部サービス連携

### 6.1 microCMS
- 用途: 商品マスタ管理
- API: REST API
- 認証: API Key（環境変数: MICROCMS_API_KEY）
- エンドポイント例:
  - GET /api/v1/products（商品一覧取得）
  - GET /api/v1/products/{id}（商品詳細取得）
  - PATCH /api/v1/products/{id}（在庫数更新）

### 6.2 Stripe
- 用途: 決済処理、webhook
- API: Stripe API v10以降
- 認証: Secret Key（環境変数: STRIPE_SECRET_KEY）
- Publishable Key（環境変数: PUBLIC_STRIPE_PUBLISHABLE_KEY）
- Webhook署名検証: Webhook Secret（環境変数: STRIPE_WEBHOOK_SECRET）
- 主要API:
  - stripe.checkout.sessions.create（セッション作成）
  - stripe.paymentIntents.list（注文一覧取得）

### 6.3 Google Sheets API
- 用途: 注文データ保存・照合
- 認証: サービスアカウント（JSON Key）
- スコープ: https://www.googleapis.com/auth/spreadsheets
- ライブラリ: googleapis（Node.js）

### 6.4 Slack
- 用途: 通知（注文、エラー、差分検出）
- 連携方法: Incoming Webhook
- Webhook URL（環境変数: SLACK_WEBHOOK_URL）

---

## 7. 開発・デプロイフロー

### 7.1 開発環境
- ローカル開発: npm run dev（Astro dev server）
- 環境変数: .env.local（Gitにコミットしない）
- テスト決済: Stripe Test Mode

### 7.2 本番環境
- ホスティング: Vercel
- 環境変数設定: Vercel Dashboard
- デプロイ: main ブランチへのpushで自動デプロイ
- ドメイン: Vercelサブドメインまたは独自ドメイン

### 7.3 Git管理
- リポジトリ: GitHub（private推奨）
- ブランチ戦略: main（本番）、develop（開発）

---

## 8. Astro Shopifyテーマ参考箇所

### 8.1 参考にする実装
- カート管理: /src/stores/cart.ts（Svelte store）
- カートドロワーUI: Svelteコンポーネント
- 商品一覧・詳細レイアウト: Tailwind CSSスタイリング
- 画像ギャラリー: 商品詳細ページのUI

### 8.2 変更箇所
- バックエンドAPI: Shopify Storefront API → microCMS REST API
- 決済: Shopify Checkout → Stripe Checkout
- 在庫管理: Shopifyネイティブ → microCMS + 自前実装
- 注文管理: Shopify Admin → Google Spreadsheet

### 8.3 Astro SSRへの移行
- Astro Shopifyテーマは一部Svelteでサーバーサイド処理を行っているが、本プロジェクトではAstro SSRとAPI Routesで処理
- クライアントサイドの動的UI（カート操作等）のみSvelteを使用

---

## 9. 実装優先順位

### Phase 1: MVP（最小機能）
1. microCMS商品データモデル作成
2. Astro SSRで商品一覧・詳細ページ実装
3. Svelteでカート機能実装
4. Stripe Checkout連携（決済のみ、在庫管理なし）

### Phase 2: 在庫管理・注文管理
5. 在庫フィールド追加、在庫表示
6. Stripe webhook実装（在庫減算）
7. Google Spreadsheet連携（注文記録）
8. Slack通知実装

### Phase 3: データ整合性
9. Vercel Cronでバッチ処理実装
10. Stripe注文データとSpreadsheet突合チェック
11. 差分検出時のSlack通知

### Phase 4: 改善・最適化（optional）
12. カテゴリ・フィルタリング機能
13. 関連商品表示
14. SEO最適化（メタタグ、構造化データ）
15. パフォーマンス最適化

---

## 10. リスク・注意事項

### 10.1 Webhook失敗リスク
- 対策: 1日1回のバッチ処理で補完
- 運用: Stripe Dashboardも定期確認

### 10.2 同時購入による在庫競合
- 対策: 先着順で処理、在庫切れ時はエラー表示
- 商品数・取引数が少ないため、過度な対策は不要

### 10.3 Vercel無料プランの制限
- Function実行時間10秒: 通常問題ないが、複雑な処理は注意
- 帯域幅100GB/月: 画像最適化で抑える

### 10.4 microCMS API制限
- 10,000回/月: 商品数少なめなら問題なし
- キャッシュ戦略でAPI呼び出しを最適化

---

## 11. 将来的な拡張案（optional）

- 会員機能: ログイン、注文履歴、お気に入り
- クーポン機能: Stripe Coupons活用
- 定期購入: Stripe Subscriptions
- 問い合わせフォーム: Vercel Functions + メール送信
- レビュー機能: microCMSで管理
- 多言語対応: Astro i18n

---

## 12. まとめ

本要件定義に基づき、以下を実現:
- 月額固定費ほぼゼロのECサイト
- Astro SSR + microCMS + Stripe構成
- 在庫管理、注文管理の自動化
- データ整合性チェックで運用安定性確保
- Astro Shopifyテーマを参考にした実装


---

## 13. 配送機能（クリックポスト連携）

### 13.1 配送方法の選定

選定理由:
- クリックポスト（日本郵便）を採用
- 全国一律185円で最安クラス
- A4サイズ、厚さ3cm以内、重量1kg以内に対応
- 追跡番号あり
- Web API経由で自動化可能
- Yahoo! JAPAN IDのみで利用開始可能（法人契約不要）

### 13.2 クリックポスト API概要

API仕様:
- 認証: Yahoo! JAPAN ID（OAuth2.0）
- エンドポイント: https://clickpost.jp/api/
- 主要機能:
  - 送り状データ登録
  - ラベルPDF取得
  - 追跡番号取得
  - 配送状況確認

API制限:
- 1日あたりの発行上限: 通常利用では問題なし
- レスポンスタイム: 数秒程度

### 13.3 Google Spreadsheet拡張

#### 13.3.1 スプレッドシート列の追加

注文一覧シートに以下の列を追加:
```
  P: 発送方法（クリックポスト/その他）
  Q: 追跡番号
  R: ラベル発行日時
  S: ラベルURL（PDF）
  T: 配送ステータス（未発送/発送済み/配達完了）
  U: 発送日
```

#### 13.3.2 発送準備シート（新規作成）

シート名: 発送準備
用途: クリックポストラベル発行用の一時データ

列:
```
  A: 注文ID（注文一覧から参照）
  B: 発送先氏名
  C: 発送先郵便番号
  D: 発送先住所
  E: 発送先電話番号（optional）
  F: 内容品名（商品名）
  G: ラベル発行ステータス（未発行/発行済み）
  H: 追跡番号
  I: エラーメッセージ
```

### 13.4 自動化の流れ

#### 13.4.1 注文確定後の自動処理

Stripe webhook（checkout.session.completed）で実行:
1. 注文データをGoogle Spreadsheet（注文一覧）に記録
2. 配送先情報を抽出（Stripeから取得）
3. 「発送準備」シートに発送データを自動追加
4. 発送方法を「クリックポスト」に設定（デフォルト）
5. ステータスを「未発送」に設定

#### 13.4.2 ラベル発行フロー

実装方法: Google Apps Script（GAS）

手動トリガー:
- スプレッドシートにカスタムメニュー「発送管理」を追加
- メニュー項目: 「選択した注文のラベル発行」

処理内容:
1. 「発送準備」シートで未発行の行を選択（チェックボックス等）
2. メニューから「ラベル発行」を実行
3. GASがクリックポストAPIを呼び出し:
   - 送り状データ登録（氏名、住所、内容品名）
   - ラベルPDF取得
4. 取得したデータをスプレッドシートに記録:
   - 追跡番号（P列）
   - ラベルURL（S列）
   - ラベル発行日時（R列）
   - ステータスを「発送済み」に更新（L列）
5. ラベルPDFを自動的にGoogle Driveに保存（optional）
6. 発行完了をSlack通知

バッチ処理（optional）:
- 毎日特定時刻（例: 午前10時）に未発行ラベルを一括発行
- Vercel Cronから「発送準備」シートをチェック
- 未発行があればSlack通知で手動確認を促す

#### 13.4.3 ラベル印刷

手順:
1. スプレッドシートのラベルURL列からPDFリンクをクリック
2. ブラウザでPDFを開く
3. A4用紙に印刷（1枚に1ラベル）
4. ラベルを商品に貼り付けて発送

効率化案:
- 複数注文分のラベルを一括でPDF結合
- GASで複数PDFを自動マージしてGoogle Driveに保存
- 1回の印刷で複数ラベル出力可能

### 13.5 クリックポスト API連携実装

#### 13.5.1 Yahoo! JAPAN ID認証

初期設定:
1. Yahoo! JAPAN ビジネスIDを取得（無料）
2. クリックポストにログイン（https://clickpost.jp）
3. APIアクセストークンを取得
4. GASのプロパティに保存（ScriptProperties）

環境変数:
```
CLICKPOST_API_TOKEN: クリックポストAPIトークン
CLICKPOST_SENDER_NAME: 差出人氏名
CLICKPOST_SENDER_POSTAL_CODE: 差出人郵便番号
CLICKPOST_SENDER_ADDRESS: 差出人住所
CLICKPOST_SENDER_PHONE: 差出人電話番号（optional）
```

#### 13.5.2 Google Apps Script実装

ファイル構成:
```
Code.gs           メイン処理
ClickPostAPI.gs   クリックポストAPI呼び出し
SheetHelper.gs    スプレッドシート操作
SlackNotifier.gs  Slack通知
Menu.gs           カスタムメニュー
```

主要関数:

Code.gs:
```javascript
// カスタムメニュー追加
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('発送管理')
    .addItem('選択した注文のラベル発行', 'createLabelsForSelected')
    .addItem('未発送注文を確認', 'checkUnshippedOrders')
    .addToUi();
}

// 選択した注文のラベル発行
function createLabelsForSelected() {
  // 発送準備シートから未発行の注文取得
  // クリックポストAPI呼び出し
  // 追跡番号・ラベルURLを記録
  // Slack通知
}
```

ClickPostAPI.gs:
```javascript
// ラベル発行APIコール
function createClickPostLabel(orderData) {
  const apiToken = PropertiesService.getScriptProperties().getProperty('CLICKPOST_API_TOKEN');
  const endpoint = 'https://clickpost.jp/api/v1/labels';
  
  const payload = {
    recipient_name: orderData.name,
    recipient_postal_code: orderData.postalCode,
    recipient_address: orderData.address,
    content: orderData.items,
    sender_name: PropertiesService.getScriptProperties().getProperty('CLICKPOST_SENDER_NAME'),
    // その他のパラメータ
  };
  
  const options = {
    method: 'post',
    headers: {
      'Authorization': 'Bearer ' + apiToken,
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify(payload)
  };
  
  const response = UrlFetchApp.fetch(endpoint, options);
  return JSON.parse(response.getContentText());
}

// 追跡番号で配送状況取得
function getShippingStatus(trackingNumber) {
  // クリックポストAPI呼び出し
  // 配送ステータス取得
}
```

SheetHelper.gs:
```javascript
// 注文一覧から発送準備データ作成
function prepareShipmentData(orderId) {
  // 注文一覧シートから該当行取得
  // 発送準備シートに書き込み
}

// ラベル情報を注文一覧に記録
function recordLabelInfo(orderId, trackingNumber, labelUrl) {
  // 注文一覧シートの該当行を更新
}
```

#### 13.5.3 エラーハンドリング

想定エラー:
1. API認証エラー → トークン再取得を促すメッセージ
2. 住所不正エラー → 該当行にエラーメッセージ記録、Slack通知
3. 重複発行エラー → スキップして次へ
4. API制限エラー → 一時停止してリトライ

エラー時の動作:
- エラー内容をスプレッドシートの「エラーメッセージ」列に記録
- Slack通知で管理者に即時連絡
- エラー行は発行ステータスを「エラー」に設定

### 13.6 配送状況の追跡

#### 13.6.1 手動確認

スプレッドシートから:
- 追跡番号列（Q列）をクリック
- 日本郵便の追跡サイトへリンク（HYPERLINK関数）
```
=HYPERLINK("https://trackings.post.japanpost.jp/services/srv/search/direct?reqCodeNo1=" & Q2, Q2)
```

#### 13.6.2 自動ステータス更新（optional）

実装方法:
- GASで定期実行（1日1回、午前中）
- クリックポストAPIまたは日本郵便追跡APIで配送状況取得
- 「配達完了」になったらステータス更新
- Slack通知（日次サマリー）

注意点:
- クリックポストAPIに配送状況取得機能があるか確認が必要
- なければ日本郵便の追跡APIを別途利用
- 過度な自動化は不要（手動確認でも十分）

### 13.7 運用フロー

#### 13.7.1 日常業務フロー

1. 朝: Slackで新規注文通知を確認
2. スプレッドシート「発送準備」シートを開く
3. 未発行の注文を確認（自動で追加されている）
4. 商品をピッキング・梱包
5. メニューから「選択した注文のラベル発行」を実行
6. ラベルPDFをダウンロード・印刷
7. ラベルを貼り付けて発送
8. 発送完了後、ステータスを「発送済み」に手動更新（optional）
9. 追跡番号を顧客にメール通知（optional、自動化可能）

#### 13.7.2 月次業務

1. 配送完了した注文を確認
2. 未完了や問題のある配送を調査
3. 月次レポート作成（発送数、配送遅延、エラー件数）

### 13.8 拡張機能（optional）

#### 13.8.1 顧客への追跡番号通知

実装方法:
- ラベル発行時に追跡番号を取得
- SendGrid等のメールAPIで顧客に自動送信
- メール内容: 「ご注文商品を発送しました。追跡番号: xxx」

コスト:
- SendGrid無料プラン: 100通/日
- 取引数が少ないため無料枠で十分

#### 13.8.2 配送完了時の自動通知

実装方法:
- GAS定期実行で配送ステータス確認
- 配達完了したら顧客にメール送信
- 「商品が配達完了しました。ご確認ください」

#### 13.8.3 複数配送方法対応

将来的な拡張:
- クリックポスト以外（レターパック、宅急便コンパクト等）も選択可能に
- 商品サイズや重量に応じて最適な配送方法を自動判定
- スプレッドシートで配送方法を選択可能に

### 13.9 コスト試算

クリックポスト利用料:
- 1件あたり 185円
- 月10件発送: 1,850円
- 月30件発送: 5,550円

その他コスト:
- 梱包資材（封筒、緩衝材等）: 1件あたり 50円〜100円程度
- 印刷費用（A4用紙、インク）: 1件あたり 10円程度

合計: 1件あたり 245円〜295円程度

他の配送方法との比較:
- 定形外郵便（規格内、100g）: 140円〜（追跡なし）
- ネコポス（契約価格）: 175円〜（契約必要）
- レターパックライト: 370円

→ クリックポストは追跡ありで中間的なコスト、自動化のしやすさで優位

### 13.10 セキュリティ・注意事項

#### 13.10.1 個人情報保護

注意点:
- 顧客の氏名・住所がスプレッドシートに記録される
- スプレッドシートのアクセス権限を厳格に管理
- 不要になった注文データは定期的に削除またはアーカイブ

対策:
- スプレッドシートを特定のGoogleアカウントのみに共有
- 2段階認証の有効化
- アクセスログの定期確認

#### 13.10.2 API認証情報管理

対策:
- GASのScriptPropertiesに保存（コード内に直接記述しない）
- 定期的にトークン更新
- アクセス権限の最小化

### 13.11 トラブルシューティング

よくある問題と対処法:

1. ラベル発行エラー
   - 原因: 住所形式が不正
   - 対処: スプレッドシートで住所を確認・修正して再実行

2. 追跡番号が取得できない
   - 原因: API接続エラー
   - 対処: APIトークン確認、ネットワーク確認

3. PDFが開けない
   - 原因: ブラウザの設定
   - 対処: 別ブラウザで試す、PDFを直接ダウンロード

4. 印刷がずれる
   - 原因: プリンター設定
   - 対処: 余白設定を「なし」、用紙サイズをA4に設定

---

## 14. 更新された実装優先順位

### Phase 1: MVP（最小機能）
1. microCMS商品データモデル作成
2. Astro SSRで商品一覧・詳細ページ実装
3. Svelteでカート機能実装
4. Stripe Checkout連携（決済のみ、在庫管理なし）

### Phase 2: 在庫管理・注文管理
5. 在庫フィールド追加、在庫表示
6. Stripe webhook実装（在庫減算）
7. Google Spreadsheet連携（注文記録）
8. Slack通知実装

### Phase 3: 配送自動化
9. Google Spreadsheetに配送関連列を追加
10. 「発送準備」シート作成
11. クリックポストAPI連携（Google Apps Script）
12. カスタムメニューでラベル発行機能実装
13. 追跡番号の記録と顧客通知（optional）

### Phase 4: データ整合性
14. Vercel Cronでバッチ処理実装
15. Stripe注文データとSpreadsheet突合チェック
16. 差分検出時のSlack通知

### Phase 5: 改善・最適化（optional）
17. 配送状況自動追跡
18. 顧客への配達完了通知
19. カテゴリ・フィルタリング機能
20. SEO最適化

---

## 15. 更新された技術スタック

### 15.1 追加された技術要素

配送管理:
- クリックポストAPI（日本郵便）
- Google Apps Script（GAS）
- メール送信API: SendGrid（optional、無料プラン）

データ管理:
- Google Spreadsheetの拡張（発送準備シート追加）
- Google Drive（ラベルPDF保存用、optional）

---

## 16. 最終まとめ

本要件定義に基づき、以下を実現:
- 月額固定費ほぼゼロのECサイト
- Astro SSR + microCMS + Stripe構成
- 在庫管理、注文管理の自動化
- クリックポストによる低コスト配送（185円/件）
- Google Apps Scriptによるラベル発行自動化
- データ整合性チェックで運用安定性確保
- Astro Shopifyテーマを参考にした実装

配送コスト（1件あたり）:
- クリックポスト: 185円
- 梱包資材: 50円〜100円
- 合計: 235円〜285円

運用負荷:
- 注文受付〜在庫減算: 完全自動
- ラベル発行: 半自動（ボタンクリックで一括発行）
- 商品梱包・発送: 手動
- データ整合性チェック: 自動（異常時のみ通知）


---

## 17. 法律対応（特定商取引法対策）

### 17.1 特定商取引法の概要

個人でネットショップを運営する場合でも特定商取引法(特商法)の対象となり、販売者情報の表示が義務付けられています。

適用対象:
- 営利目的で反復継続して通信販売を行う者
- 個人・法人を問わず適用
- ハンドメイド作品や自主制作品の販売も該当

違反した場合:
- 行政処分(業務改善指示、業務停止命令)
- 罰金(最大100万円)
- 消費者からの信頼喪失

### 17.2 必須表示事項

ECサイトに以下の情報を「特定商取引法に基づく表記」として明記する必要があります:

1. 販売業者の氏名(名称)
   - 個人の場合: 本名
   - 屋号がある場合: 「本名(屋号: ○○)」と併記

2. 所在地(住所)
   - 登記している住所または実際に活動している住所
   - 郵便番号を含む完全な住所

3. 電話番号
   - 連絡可能な電話番号

4. メールアドレス
   - 問い合わせ対応可能なメールアドレス

5. 販売価格
   - 税込価格の明示
   - 商品代金以外の費用(送料等)

6. 代金の支払方法・支払時期
   - クレジットカード(即時決済)等

7. 商品の引渡時期
   - 「ご注文後3〜7営業日以内に発送」等

8. 返品・交換の条件
   - 返品可否、返品期限、返品時の送料負担等
   - 返品不可の場合はその旨を明記

9. 事業者の代表者名または運営責任者名
   - 個人事業主の場合は氏名

### 17.3 住所・電話番号の公開問題と対策

個人で自宅住所を公開することはプライバシー上のリスクがあります。

対策方法:

#### 17.3.1 バーチャルオフィスの利用(推奨)

消費者庁の見解では、以下の条件を満たせばバーチャルオフィスの住所・電話番号の利用が可能:

条件:
1. プラットフォーム事業者またはバーチャルオフィス事業者が実際の販売者情報を把握している
2. トラブル発生時に確実に連絡が取れる体制がある
3. 消費者からの問い合わせが迅速に転送される
4. 請求があった場合に遅滞なく実際の住所・電話番号を開示できる

おすすめのバーチャルオフィス(東京):
- バーチャルオフィス1(渋谷): 月額880円
- GMOオフィスサポート: 月額660円〜
- レゾナンス: 月額990円〜
- TAPIOCA(青山・渋谷): 月額290円
- BLOOM(新宿): 月額300円〜
- METSオフィス: 月額270円〜

選定基準:
- 料金の安さ
- 郵便物転送サービスの有無
- 法人登記の可否(将来的な法人化に備える)
- 運営会社の信頼性
- 銀行口座開設サポートの有無

バーチャルオフィス利用時の注意:
- ネットショップ開設時に住所をテキストで記載可能か確認(一部サービスでは画像処理を要求される場合がある)
- 郵便物転送の頻度と料金を確認
- 契約時の審査に事業内容の提出が必要

#### 17.3.2 私書箱の利用

消費者庁のガイドラインでは、以下の条件を満たせば私書箱も利用可能:
- 郵便により連絡が取れる
- 請求があれば遅滞なく実際の住所を開示できる

ただし、バーチャルオフィスの方が信頼性が高く、法人登記も可能なため推奨。

#### 17.3.3 請求時開示方式

住所・電話番号を広告に記載せず、「請求があった場合には遅滞なく開示する」旨を記載する方式。

記載例:
```
住所・電話番号につきましては、請求があった場合には遅滞なく開示いたします。
お問い合わせフォームまたはメールにてご連絡ください。
```

注意点:
- 開示請求があった際に速やかに対応できる体制が必要
- 対応が遅れると法律違反となる可能性
- 消費者からの信頼度が下がる可能性

Ryoyaさんの場合の推奨:
- バーチャルオフィス利用(月額300円〜880円程度)
- 住所・電話番号は明記して信頼性を確保
- プライバシー保護とコストのバランスが最適

### 17.4 特商法ページの実装

#### 17.4.1 ページ構成

ページパス: `/legal/tokusho`

必須項目を全て記載した専用ページを作成し、フッターやヘッダーから容易にアクセスできるようにする。

#### 17.4.2 記載例テンプレート

```
特定商取引法に基づく表記

販売業者
[氏名]([屋号: ○○])

運営責任者
[氏名]

所在地
〒[郵便番号]
[都道府県][市区町村][番地・建物名]
※バーチャルオフィス利用の場合はその住所

電話番号
[電話番号]
※お問い合わせはメールにてお願いいたします

メールアドレス
[メールアドレス]

販売価格
各商品ページに記載(税込価格)

商品代金以外の必要料金
- 送料: 全国一律185円(クリックポスト)
- 決済手数料: 無料(Stripe手数料は販売価格に含まれます)

支払方法
クレジットカード決済(Stripe)
※ご注文時に即時決済となります

商品の引渡時期
ご注文確認後、3〜7営業日以内に発送いたします
※在庫状況により遅れる場合がございます

返品・交換について
商品の性質上、お客様都合による返品・交換は原則としてお受けできません。
ただし、以下の場合は返品・交換を承ります:
- 商品に不良・破損があった場合
- 注文と異なる商品が届いた場合

上記の場合、商品到着後7日以内にメールにてご連絡ください。
返品送料は当方負担にて対応いたします。

個人情報の取り扱いについて
お客様からお預かりした個人情報は、商品の発送および当店からのご連絡にのみ使用し、第三者に譲渡・開示することはございません。
詳細は「プライバシーポリシー」をご確認ください。
```

#### 17.4.3 実装方法

Astroページとして実装:
```typescript
// src/pages/legal/tokusho.astro
---
import BaseLayout from '@/layouts/BaseLayout.astro';
---

<BaseLayout title="特定商取引法に基づく表記">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <h1 class="text-3xl font-bold mb-8">特定商取引法に基づく表記</h1>
    
    <div class="space-y-6">
      <!-- 販売業者 -->
      <section>
        <h2 class="text-xl font-semibold mb-2">販売業者</h2>
        <p>[氏名]([屋号: ○○])</p>
      </section>
      
      <!-- その他の項目 -->
      <!-- ... -->
    </div>
  </div>
</BaseLayout>
```

フッターにリンク追加:
```astro
<footer>
  <nav>
    <a href="/legal/tokusho">特定商取引法に基づく表記</a>
    <a href="/legal/privacy">プライバシーポリシー</a>
  </nav>
</footer>
```

### 17.5 その他の関連法規

#### 17.5.1 個人情報保護法

顧客の氏名・住所・メールアドレス等の個人情報を取り扱う場合、以下が必要:

1. 利用目的の明示
   - 商品発送、問い合わせ対応のため等

2. 適切な管理
   - Google Spreadsheetのアクセス権限を厳格に管理
   - 2段階認証の有効化

3. 第三者提供の禁止
   - 顧客情報を他社に提供しない

4. プライバシーポリシーの作成・公開

プライバシーポリシーページ: `/legal/privacy`

#### 17.5.2 景品表示法

誇大広告の禁止:
- 実際より優良に見せる表示の禁止
- 「効果抜群」「絶対に○○」等の断定的表現に注意
- 商品写真と実物の差異に注意

対策:
- 商品説明は正確に記載
- 過度な美化や加工を避ける
- 実物の写真を使用

#### 17.5.3 著作権法・商標権

自主制作品でも注意が必要:
- 既存キャラクター・ブランドロゴの無断使用禁止
- キャラクター生地の使用は権利者の許可が必要
- 他作家の作品の模倣販売は違法

対策:
- オリジナルデザインのみ販売
- 素材の利用規約を確認
- 不明な場合は権利者に問い合わせ

#### 17.5.4 製造物責任法(PL法)

商品の欠陥により消費者が損害を被った場合の責任:
- 製造者(作家)が責任を負う
- PL保険への加入を検討

PL保険:
- 年間数千円〜で加入可能
- ハンドメイド作家向けの保険商品あり
- 商品の種類により保険料が変動

#### 17.5.5 家庭用品品質表示法

対象商品がある場合、品質表示が必要:
- 繊維製品(衣類、タオル等)
- プラスチック製品(食器等)
- 雑貨類

表示内容:
- 素材・材質
- 取り扱い上の注意
- 製造者名または販売者名
- 連絡先

実装方法:
- 商品タグに記載
- 商品ページにも明記

### 17.6 開業届と確定申告

#### 17.6.1 個人事業の開業届

提出先: 納税地の税務署
期限: 事業開始から1ヶ月以内
費用: 無料

提出するメリット:
- 青色申告が可能(最大65万円の控除)
- 屋号で銀行口座開設可能
- 事業の信頼性向上

#### 17.6.2 確定申告

必要な所得額:
- 副業の場合: 年間所得20万円以上
- 本業の場合: 年間所得48万円以上

所得 = 収入(売上) - 経費

確定申告の種類:
- 白色申告: 簡易、控除なし
- 青色申告: 複式簿記、最大65万円控除(開業届+青色申告承認申請書が必要)

推奨:
- 開業届と青色申告承認申請書を提出
- 会計ソフト利用(freee、マネーフォワード等)

### 17.7 実装優先順位への反映

Phase 1に追加:
0. 特商法対策・法律対応
   - バーチャルオフィス契約(月額300円〜880円)
   - 特商法ページ作成(/legal/tokusho)
   - プライバシーポリシーページ作成(/legal/privacy)
   - 開業届の提出(任意だが推奨)

### 17.8 コスト試算(更新)

月額固定費:
- バーチャルオフィス: 300円〜880円
- その他サービス: 0円(microCMS、Stripe、Vercel等は従量課金)

合計月額固定費: 300円〜880円

年間コスト:
- バーチャルオフィス: 3,600円〜10,560円
- PL保険(optional): 3,000円〜10,000円

初期費用:
- バーチャルオフィス初期費用: 0円〜5,500円(サービスにより異なる)
- 開業届: 無料

---

## 18. 更新された最終まとめ

本要件定義に基づき、以下を実現:

技術面:
- 月額固定費300円〜880円のECサイト(バーチャルオフィス代のみ)
- Astro SSR + microCMS + Stripe構成
- 在庫管理、注文管理の自動化
- クリックポストによる低コスト配送(185円/件)
- Google Apps Scriptによるラベル発行自動化
- データ整合性チェックで運用安定性確保
- Astro Shopifyテーマを参考にした実装

法律面:
- 特定商取引法完全対応
- バーチャルオフィスでプライバシー保護
- 個人情報保護法、景品表示法、著作権法等への配慮
- 開業届・青色申告で節税対策

運用面:
- 注文受付〜在庫減算: 完全自動
- ラベル発行: 半自動(ボタンクリックで一括発行)
- 商品梱包・発送: 手動
- データ整合性チェック: 自動(異常時のみ通知)
- 特商法対応: 初期設定後はメンテナンス不要

総コスト(1件あたり):
- 決済手数料(Stripe 3.6%): 商品価格による
- クリックポスト: 185円
- 梱包資材: 50円〜100円
- 月額固定費按分: 商品数・取引数により変動

個人の自主制作品販売に最適な、低コスト・低リスク・法令遵守のECサイト構成です。

