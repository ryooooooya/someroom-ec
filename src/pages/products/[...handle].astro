---
import { getProductBySlug, getProducts } from "../../utils/microcms";
import { priceToMoney } from "../../utils/schemas";
import { setCache } from "../../utils/cache";

import BaseLayout from "../../layouts/BaseLayout.astro";
import NotFoundLayout from "../../layouts/NotFoundLayout.astro";

import AddToCartForm from "../../components/AddToCartForm.svelte";
import ProductImageGallery from "../../components/ProductImageGallery.astro";
import ProductCardByMicrocms from "../../components/ProductCardByMicrocms.astro";
import Money from "../../components/Money.svelte";
import ProductListXScrollWrap from "../../components/ProductListXScrollWrap.astro";

const { handle } = Astro.params;
const product = await getProductBySlug(handle || "");

if (!product) {
  Astro.response.status = 404;
}

setCache.medium(Astro);

// Build filters for related products
const seriesIds = product?.series?.map((s) => s.id) || [];
const designerIds = product?.designers?.map((d) => d.id) || [];
const categoryIds = product?.categories?.map((c) => c.id) || [];

// Fetch related products
const [seriesProducts, designerProducts, categoryProducts] = await Promise.all([
  seriesIds.length > 0
    ? getProducts({
        filters: `id[not_equals]${product!.id}[and]series[contains]${seriesIds[0]}${seriesIds.slice(1).map(id => `[or]series[contains]${id}`).join('')}`,
        limit: 20,
        depth: 1
      })
    : Promise.resolve({ contents: [] }),
  designerIds.length > 0
    ? getProducts({
        filters: `id[not_equals]${product!.id}[and]designers[contains]${designerIds[0]}${designerIds.slice(1).map(id => `[or]designers[contains]${id}`).join('')}`,
        limit: 20,
        depth: 1
      })
    : Promise.resolve({ contents: [] }),
  categoryIds.length > 0
    ? getProducts({
        filters: `id[not_equals]${product!.id}[and]categories[contains]${categoryIds[0]}${categoryIds.slice(1).map(id => `[or]categories[contains]${id}`).join('')}`,
        limit: 20,
        depth: 1
      })
    : Promise.resolve({ contents: [] })
]);

// Map products to their respective categories
const productsListSeries = product?.series?.map((series) => (
  seriesProducts.contents.filter((p: any) =>
    p.series.some((ser: any) => ser.id === series.id)
  )
)) || [];
const productsListDesigner = product?.designers?.map((designer) => (
  designerProducts.contents.filter((p: any) =>
    p.designers.some((creator: any) => creator.id === designer.id)
  )
)) || [];
const productsListCat = product?.categories?.map((category) => (
  categoryProducts.contents.filter((p: any) =>
    p.categories.some((cat: any) => cat.id === category.id)
  )
)) || [];
---

{
  !product ? (
    <NotFoundLayout title="Product not found" message="Product not found" />
  ) : (
    <BaseLayout title={product.name}>
      <section class="pt-20 pb-8">
        <div class="grid grid-cols-2 gap-12 max-xs:grid-cols-1">
          <div class="">
            <ProductImageGallery images={product.images || []} />
          </div>
          <div class="pt-6">
            <h1 class="text-2xl">
              {product.name}
            </h1>
            <p class="mt-6 text-[28px] leading-6">
              <Money price={priceToMoney(product.price)} size="lg" />
              <span class="text-base"> （税込）</span>
            </p>
            <div class="max-w-[200px] mt-5 max-xs:max-w-full">
              <AddToCartForm
                client:load
                productId={product.id}
                productName={product.name}
                productPrice={product.price}
                productImage={product.images?.[0] || null}
                productSlug={product.slug || product.id}
                stock={product.stock}
                isActive={product.isActive}
              />
            </div>
            <dl class="grid grid-cols-[auto_1fr] gap-x-2 gap-y-5 mt-12">
              <dd class="text-xs -mt-1 text-right">
                Designer:
              </dd>
              <dt class="text-xl text-underline hover:no-underline">
                {product.designers.map((designer) => (
                  <a href={`/designers/${designer.id}`}>{designer.nameJa}</a>
                ))}
              </dt>
              <dd class="text-xs -mt-1 text-right">
                Size:
              </dd>
              <dt class="text-xl text-underline hover:no-underline">
                {product.size}
              </dt>
              <dd class="text-xs -mt-1 text-right">
                Series:
              </dd>
              <dt class="text-xl text-underline hover:no-underline">
                {product.series.map((series) => (
                  <a href={`/series/${series.id}`}>{series.title}</a>
                ))}
              </dt>
              {product.text && (
                <>
                  {product.text.map((contents) => (
                    <>
                      <dd class="text-xs -mt-1 text-right">
                        {contents.title}:
                      </dd>
                      <dt class="text-xl">
                        <div set:html={contents.description} />
                      </dt>
                    </>
                  ))}
                </>
              )}
              <dd class="text-xs -mt-1 text-right">
                Notes:
              </dd>
              <dt class="text-xl text-underline hover:no-underline">
                {product.link.map((note) =>(
                  <a href={note.url} target="_blank" rel="noopener noreferrer">{note.text}</a>
                ))}
              </dt>
            </dl>
          </div>
        </div>
      </section>
      {product.series && product.series.length > 0 && product.series.map((series: any, index: number) =>(
        productsListSeries[index] && productsListSeries[index].length > 0 && (
          <section class="mt-24">
            <p class="flex items-start gap-1">
              <span class="text-xs">Series :</span>
              <span class="text-2xl">{series.title}</span>
            </p>
            <ProductListXScrollWrap>
              {productsListSeries[index].map((p: any) => (
                <ProductCardByMicrocms
                  product={p}
                  className="max-w-[200px] min-w-[163px] max-xs:min-w-[calc(50%-16px)]"
                />
              ))}
            </ProductListXScrollWrap>
          </section>
        )
      ))}
      {product.designers && product.designers.length > 0 && product.designers.map((designer: any, index: number) =>(
        productsListDesigner[index] && productsListDesigner[index].length > 0 && (
          <section class="mt-24">
            <p class="flex items-start gap-1">
              <span class="text-xs">Designer :</span>
              <span class="text-2xl">{designer.nameJa}</span>
            </p>
            <ProductListXScrollWrap>
              {productsListDesigner[index].map((p: any) => (
                <ProductCardByMicrocms
                  product={p}
                  className="max-w-[200px] min-w-[163px] max-xs:min-w-[calc(50%-16px)]"
                />
              ))}
            </ProductListXScrollWrap>
          </section>
        )
      ))}
      {product.categories && product.categories.length > 0 && product.categories.map((category: any, index: number) => (
        productsListCat[index] && productsListCat[index].length > 0 && (
          <section class="mt-24">
            <p class="flex items-start gap-1">
              <span class="text-xs">Category :</span>
              <span class="text-2xl">{category.name}</span>
            </p>
            <ProductListXScrollWrap>
              {productsListCat[index].map((p: any) => (
                <ProductCardByMicrocms
                  product={p}
                  className="max-w-[200px] min-w-[163px] max-xs:min-w-[calc(50%-16px)]"
                />
              ))}
            </ProductListXScrollWrap>
          </section>
        )
      ))}
      <div class="mt-20">
        <a href="/" class="text-underline text-2xl hover:no-underline">
          Back
        </a>
      </div>
    </BaseLayout>
  )
}
