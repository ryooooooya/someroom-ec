---
import { getSeries, getProducts } from "../../utils/microcms";
import { setCache } from "../../utils/cache";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ProductCardByMicrocms from "../../components/ProductCardByMicrocms.astro";
import ProductListXScrollWrap from "../../components/ProductListXScrollWrap.astro";

const title = "SomeRoom";

// Fetch series and all products in parallel for better performance
const [series, allProducts] = await Promise.all([
  getSeries({ limit: 100 }),
  getProducts({ limit: 100 })
]);

// Group products by series for efficient lookup
const productsBySeries = new Map();
allProducts.contents.forEach((product: any) => {
  product.series?.forEach((ser: any) => {
    if (!productsBySeries.has(ser.id)) {
      productsBySeries.set(ser.id, []);
    }
    productsBySeries.get(ser.id).push(product);
  });
});

// Apply static cache for series list page
setCache.static(Astro);
---

<BaseLayout title={title} currentPage="series">
  <section class="h-full pt-10 pb-12 max-sm:pt-16">
    <h2 class="text-xs">
      All series:
    </h2>
    <div class="flex flex-col gap-y-16 mt-3 max-md:gap-y-12 max-sm:gap-y-8">
      {series.contents.map((content: any) => {
        const seriesProducts = productsBySeries.get(content.id) || [];
        return (
          <ProductListXScrollWrap>
            <a href={`/series/${content.id}`} class="max-w-[200px] min-w-[163px] max-xs:min-w-[calc(50%-16px)]">
              <h3 class="text-xl text-underline hover:no-underline whitespace-normal">
                {content.title}
              </h3>
              <p class="mt-2 text-base line-clamp-5 whitespace-normal">
                {content.text}
              </p>
            </a>
            <>
              {seriesProducts.slice(0, 10).map((product: any) => (
                <ProductCardByMicrocms
                  product={product}
                  className="max-w-[200px] min-w-[163px] max-xs:min-w-[calc(50%-16px)]"
                  noSeries
                />
              ))}
            </>
          </ProductListXScrollWrap>
        );
      })}
    </div>
  </section>
</BaseLayout>
